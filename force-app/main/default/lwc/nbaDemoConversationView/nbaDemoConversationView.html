<template>
    <!-- No SMS contacts -->
    <template if:false={hasSmsContacts}>
        <div class="empty-state">
            <lightning-icon icon-name="utility:chat" size="small" class="empty-icon"></lightning-icon>
            <p class="empty-text">No contacts with SMS numbers found.</p>
        </div>
    </template>

    <template if:true={hasSmsContacts}>
        <!-- Contact picker dropdown -->
        <div class="contact-picker">
            <button class="contact-selector" onclick={toggleContactDropdown}>
                <span class="selector-initials">{selectedContactInitials}</span>
                <span class="selector-name">{selectedContactName}</span>
                <template if:true={isSelectedOptedOut}>
                    <span class="selector-opted-out">Opted Out</span>
                </template>
                <lightning-icon
                    icon-name={contactDropdownChevron}
                    size="xx-small"
                    class="selector-chevron">
                </lightning-icon>
            </button>
            <template if:true={showContactDropdown}>
                <div class="contact-dropdown">
                    <template for:each={contactDropdownItems} for:item="item">
                        <button key={item.contactId}
                                class={item.itemClass}
                                data-contact-id={item.contactId}
                                onclick={handleContactSelect}>
                            <span class="dropdown-initials">{item.initials}</span>
                            <div class="dropdown-info">
                                <span class="dropdown-name">{item.name}</span>
                                <template if:true={item.optedOut}>
                                    <span class="dropdown-opted-out">Opted Out</span>
                                </template>
                            </div>
                            <template if:true={item.isSelected}>
                                <lightning-icon icon-name="utility:check" size="xx-small" class="dropdown-check"></lightning-icon>
                            </template>
                        </button>
                    </template>
                </div>
            </template>
        </div>

        <!-- Chat area -->
        <div class="chat-area">
            <template if:true={isLoading}>
                <div class="chat-loading">
                    <lightning-spinner alternative-text="Loading messages" size="small"></lightning-spinner>
                </div>
            </template>

            <template if:false={isLoading}>
                <template if:false={hasMessages}>
                    <div class="chat-empty">
                        <p class="empty-text">No messages yet with {selectedContactName}.</p>
                    </div>
                </template>

                <template if:true={hasMessages}>
                    <div class="chat-messages">
                        <template for:each={computedMessages} for:item="item">
                            <!-- Date header -->
                            <template if:true={item.isDateHeader}>
                                <div key={item.key} class="date-header">
                                    <span class="date-label">{item.dateLabel}</span>
                                </div>
                            </template>
                            <!-- Message bubble -->
                            <template if:false={item.isDateHeader}>
                                <div key={item.key} class={item.alignClass}>
                                    <div class={item.bubbleClass}>
                                        <p class="bubble-text">{item.message}</p>
                                        <div class="bubble-meta">
                                            <span class="bubble-time">{item.timeLabel}</span>
                                            <template if:true={item.statusLabel}>
                                                <span class="bubble-status">{item.statusLabel}</span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                </template>
            </template>
        </div>

        <!-- Opted-out warning -->
        <template if:true={isSelectedOptedOut}>
            <div class="opt-out-banner">
                <lightning-icon icon-name="utility:warning" size="xx-small"></lightning-icon>
                <span>This contact has opted out of SMS.</span>
            </div>
        </template>

        <!-- Compose area -->
        <template if:false={isSelectedOptedOut}>
            <div class="compose-area">
                <div class="compose-input-row">
                    <lightning-textarea
                        value={messageBody}
                        onchange={handleBodyChange}
                        onkeydown={handleKeyDown}
                        placeholder="Type a message..."
                        variant="label-hidden"
                        class="compose-textarea">
                    </lightning-textarea>
                    <button class="send-btn" onclick={handleSend} disabled={sendDisabled}>
                        <lightning-icon icon-name="utility:send" size="xx-small" variant="inverse"></lightning-icon>
                    </button>
                </div>
                <div class={characterCountClass}>{characterCountLabel}</div>
                <template if:true={sendError}>
                    <div class="send-error">{sendError}</div>
                </template>
            </div>
        </template>
    </template>
</template>

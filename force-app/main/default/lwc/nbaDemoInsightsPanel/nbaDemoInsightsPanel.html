<template>
    <div class="insights-container">
        <div class="insights-header" onclick={toggleExpand}>
            <div class="insights-header-left">
                <div class="lightbulb-icon">
                    <lightning-icon icon-name="utility:light_bulb" size="small" variant="inverse"></lightning-icon>
                </div>
                <span class="insights-title">{panelTitle}</span>
            </div>
            <div class="insights-header-right">
                <span class="insights-count">{insightCountLabel}</span>
                <lightning-icon icon-name={expandIcon} size="xx-small"></lightning-icon>
            </div>
        </div>
        <template lwc:if={isExpanded}>
            <div class="insights-body">
                <!-- Action Mode: instruction + reason -->
                <template lwc:if={showActionContext}>
                    <div class="action-instruction">
                        <lightning-icon icon-name={stepMethodIcon} size="xx-small"></lightning-icon>
                        <span>{stepInstruction}</span>
                    </div>
                    <template lwc:if={currentAction.reasonText}>
                        <p class="action-reason">{currentAction.reasonText}</p>
                    </template>
                    <!-- Phase 7: Enhanced cadence context -->
                    <template lwc:if={showCadenceContext}>
                        <div class="cadence-context">
                            <!-- Progress bar -->
                            <div class="cadence-progress-row">
                                <lightning-icon icon-name="utility:steps" size="xx-small"></lightning-icon>
                                <span class="cadence-progress-text">{cadenceProgressText}</span>
                                <span class="cadence-fraction-badge">{cadenceProgressFraction}</span>
                            </div>
                            <div class="progress-bar-track">
                                <div class="progress-bar-fill" style={progressBarStyle}></div>
                            </div>
                            <!-- Upcoming steps -->
                            <template lwc:if={hasUpcomingSteps}>
                                <div class="upcoming-steps">
                                    <span class="upcoming-label">Up next:</span>
                                    <template for:each={upcomingStepsList} for:item="step">
                                        <div key={step.key} class="upcoming-step-item">
                                            <lightning-icon icon-name="utility:chevronright" size="xx-small"></lightning-icon>
                                            <span>{step.text}</span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </template>

                <!-- Record Page Mode: drivers + tags -->
                <template lwc:if={showDrivers}>
                    <ul class="insights-list">
                        <template for:each={insightsData.drivers} for:item="driver">
                            <li key={driver} class="insight-item">
                                <lightning-icon icon-name="utility:chevronright" size="xx-small"></lightning-icon>
                                {driver}
                            </li>
                        </template>
                    </ul>
                    <div class="insights-tags">
                        <template for:each={computedTags} for:item="tag">
                            <span key={tag.label} class={tag.cssClass}>{tag.label}</span>
                        </template>
                    </div>
                </template>
            </div>
        </template>
    </div>
</template>
